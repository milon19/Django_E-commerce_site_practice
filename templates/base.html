{% load static %}
<!doctype html>
<html lang="en" class="h-100">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        {% block title %}
            <title></title>
        {% endblock %}

        <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
        <link rel="stylesheet" href="{% static 'style.css' %}">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
{#        <script src="https://kit.fontawesome.com/e0bdb99948.js" crossorigin="anonymous"></script>#}
    </head>

    <body class="d-flex flex-column h-100">
        {% include 'snippets/navbar.html' %}

        <main role="main" class="flex-shrink-0">
            <div class="container-fluid py-4 mt-5">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endfor %}
                {% endif %}
                {% block contain %}
                {% endblock %}
            </div>
        </main>


        {% include 'snippets/footer.html' %}
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="{% static 'js/popper.min.js' %}" ></script>
        <script src="{% static 'js/bootstrap.bundle.js' %}"></script>

        <script>
            $(document).ready(function (){
                // Auto Search
                var searchForm = $('.search-form')
                var searchInput = searchForm.find('[name="q"]')
                var typingTimer;
                var typingIntervel = 1500;
                var searchBtn = searchForm.find('[type="submit"]')

                searchInput.keyup(function (event){
                    clearTimeout(typingTimer);
                    typingTimer = setTimeout(perfomSearch, typingIntervel);
                })

                searchInput.keydown(function (event){
                    clearTimeout(typingTimer);
                })

                function doingSearch(){
                    searchBtn.addClass('disabled');
                    searchBtn.html("<i class=\"fa fa-spinner fa-spin\"></i> Searching");
                }

                function perfomSearch(){
                    doingSearch()
                    var query = searchInput.val();
                    setTimeout(function (){
                        window.location.href = '/search/?q=' + query;
                    }, 1000);
                }


                // Cart + Add Products
                var productForm = $('.product-ajax')
                productForm.submit(function (event){
                    event.preventDefault();
                    var thisForm = $(this)
                    // var actionEndPoint = thisForm.attr('action');
                    var actionEndPoint = thisForm.attr('data-endpoint');
                    var httpMethod = thisForm.attr('method');
                    var formData = thisForm.serialize();

                    $.ajax({
                        url: actionEndPoint,
                        method: httpMethod,
                        data: formData,
                        success: function (data){
                            var submitSpan = thisForm.find('.submit-span')
                            if(data.added){
                                submitSpan.html('In cart <button type="submit" class=\'btn btn-link\'>Remove?</button>')
                            }else{
                                submitSpan.html('<button type="submit" class=\'btn btn-success\'>Add to cart</button>')
                            }
                            var navbarCount = $('.navbar-cart-count')
                            navbarCount.text(data.cartItemCount)
                            var currentPath = window.location.href
                            if(currentPath.indexOf('cart') != -1){
                                refreshCart()
                            }
                        },
                        error: function (errorData){
                            console.log("Error")
                            console.log(errorData)
                        }
                    })
                })

                function refreshCart(){
                    console.log('in current cart')
                    var cartTable = $('.cart-table')
                    var cartBody = cartTable.find('.cart-body')
                    var productRows = cartBody.find('.cart-product')
                    var currentUrl = window.location.href

                    {#cartBody.html('<h1>Changed</h1>')#}
                    var refreshCartUrl = 'api/cart/';
                    var refreshCartMethod = 'GET';
                    var data = {};
                    $.ajax({
                        url: refreshCartUrl,
                        method: refreshCartMethod,
                        data: data,
                        success: function (data){

                            var hiddenCartRemoveForm = $('.cart-item-remove-form')
                            if(data.products.length > 0){
                                productRows.html('')
                                i = data.products.length
                                $.each(data.products, function (index, value){
                                    var newCartItemRemove = hiddenCartRemoveForm.clone()
                                    newCartItemRemove.css('display', 'block')
                                    newCartItemRemove.find('.cart-product-id').val(value.id)
                                    cartBody.prepend(
                                        '<tr>' +
                                        '<th scope=\"row\">' + i + "</th>" +
                                        "<td><a href='" + value.url + "'>" + value.title + '</a>' + newCartItemRemove.html() + '</td>' +
                                        '<td>' + value.price + '</td>' +
                                        '</tr>'
                                    )
                                    i--
                                })
                                cartBody.find('.cart-subtotal').text(data.subtotal)
                            } else{
                                window.location.href = currentUrl
                            }
                        },
                        error: function (errorData){
                            console.log('error')
                        }

                    })
                }
            })
        </script>
    </body>
</html>